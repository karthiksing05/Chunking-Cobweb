<!doctype html>
    <html>
    <head>
    <meta charset="utf-8"/>
    <title>Parse Tree</title>
    <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #tree-container { display: inline-block; }
    .link { fill: none; stroke: #9aa1a9; stroke-width: 1.5px; }
    .node-box { stroke: #444; fill: #fff; rx: 8; ry: 8; filter: drop-shadow(1px 2px 2px rgba(0,0,0,0.15)); }
    .node-fo table { border-collapse: collapse; font-size: 12px; margin: 4px 0; }
    .node-fo th, .node-fo td { border: 1px solid #888; padding: 2px 6px; }
    .node-fo th { background: #f3f5f7; font-weight: 600; }
    .section-title { font-weight: bold; margin-top: 4px; }
    .section { margin-top: 10px; margin-bottom: 10px; }
    .subtable b { display: inline-block; margin: 6px 0 2px; }
    .subtable table { border-collapse: collapse; }
    .subtable td { border: 1px solid #bbb; padding: 1px 4px; }
    </style>
    </head>
    <body>
    <div id="tree-container">
    <div id="tree"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script>
    const data = {"title": "af0e6ff829", "left": [], "right": [], "before": [], "after": [], "children": [{"title": "2f286fc9fc", "left": [{"key": "CONCEPT-2739233090999916_1", "val": 1.0}, {"key": "CONCEPT-2739252720978250_2852", "val": 1.0}, {"key": "CONCEPT-2739252721182750_2863", "val": 1.0}, {"key": "CONCEPT-2739252721307500_2881", "val": 1.0}, {"key": "CONCEPT-2739253313881250_3185", "val": 1.0}, {"key": "CONCEPT-2739253313951750_3188", "val": 1.0}, {"key": "CONCEPT-2739253314031791_3191", "val": 1.0}], "right": [{"key": "CONCEPT-2739233090999916_1", "val": 1.0}, {"key": "CONCEPT-2739253312826000_3106", "val": 1.0}, {"key": "CONCEPT-2739253313031375_3137", "val": 1.0}, {"key": "CONCEPT-2739253313154958_3154", "val": 1.0}, {"key": "CONCEPT-2739253313674416_3173", "val": 1.0}, {"key": "CONCEPT-2739253313881250_3185", "val": 1.0}, {"key": "CONCEPT-2739253313951750_3188", "val": 1.0}], "before": [], "after": [], "children": [{"title": "5d764ba819", "left": [{"key": "CONCEPT-2739233090999916_1", "val": 1.0}, {"key": "CONCEPT-2739250549663791_2252", "val": 1.0}, {"key": "CONCEPT-2739250549706708_2254", "val": 1.0}, {"key": "CONCEPT-2739250549726458_2256", "val": 1.0}, {"key": "CONCEPT-2739250549794375_2266", "val": 1.0}, {"key": "CONCEPT-2739250567183166_2327", "val": 1.0}, {"key": "CONCEPT-2739251091889000_2479", "val": 1.0}], "right": [{"key": "lazy", "val": 1.0}], "before": [], "after": [{"key": "woman", "val": 1.0}, {"key": "with", "val": 0.5}, {"key": "the", "val": 0.3333333333333333}], "children": [{"title": "eb2b3d5589", "left": [{"key": "CONCEPT-2739233090999916_1", "val": 1.0}, {"key": "CONCEPT-2739236583586083_223", "val": 1.0}, {"key": "CONCEPT-2739236583647416_230", "val": 1.0}, {"key": "CONCEPT-2739236583664750_233", "val": 1.0}, {"key": "CONCEPT-2739236583680958_236", "val": 1.0}, {"key": "CONCEPT-2739238953018041_294", "val": 1.0}, {"key": "CONCEPT-2739238953067833_298", "val": 1.0}], "right": [{"key": "a", "val": 1.0}], "before": [], "after": [{"key": "lazy", "val": 1.0}, {"key": "woman", "val": 0.5}, {"key": "with", "val": 0.3333333333333333}], "children": [{"title": "21fd0dd200", "left": [{"key": "CONCEPT-2739233090999916_1", "val": 1.0}, {"key": "CONCEPT-2739235857243250_138", "val": 1.0}, {"key": "CONCEPT-2739235857383166_157", "val": 1.0}, {"key": "CONCEPT-2739235857402875_160", "val": 1.0}, {"key": "CONCEPT-2739235857420958_163", "val": 1.0}, {"key": "CONCEPT-2739235857438208_166", "val": 1.0}, {"key": "CONCEPT-2739235857455833_169", "val": 1.0}], "right": [{"key": "liked", "val": 1.0}], "before": [], "after": [{"key": "a", "val": 1.0}, {"key": "lazy", "val": 0.5}, {"key": "woman", "val": 0.3333333333333333}], "children": [{"title": "26e23ce133", "left": [{"key": "a", "val": 1.0}], "right": [{"key": "woman", "val": 1.0}], "before": [], "after": [{"key": "liked", "val": 1.0}, {"key": "a", "val": 0.5}, {"key": "lazy", "val": 0.3333333333333333}], "children": [{"title": "8992505e86", "left": [{"key": "a", "val": 1.0}], "right": [], "before": [], "after": [{"key": "woman", "val": 1.0}, {"key": "liked", "val": 0.5}, {"key": "a", "val": 0.3333333333333333}], "children": []}, {"title": "43fb65ab19", "left": [{"key": "woman", "val": 1.0}], "right": [], "before": [{"key": "a", "val": 1.0}], "after": [{"key": "liked", "val": 1.0}, {"key": "a", "val": 0.5}, {"key": "lazy", "val": 0.3333333333333333}], "children": []}]}, {"title": "037a7a5e7d", "left": [{"key": "liked", "val": 1.0}], "right": [], "before": [{"key": "woman", "val": 1.0}, {"key": "a", "val": 0.5}], "after": [{"key": "a", "val": 1.0}, {"key": "lazy", "val": 0.5}, {"key": "woman", "val": 0.3333333333333333}], "children": []}]}, {"title": "aacca845c0", "left": [{"key": "a", "val": 1.0}], "right": [], "before": [{"key": "liked", "val": 1.0}, {"key": "woman", "val": 0.5}, {"key": "a", "val": 0.3333333333333333}], "after": [{"key": "lazy", "val": 1.0}, {"key": "woman", "val": 0.5}, {"key": "with", "val": 0.3333333333333333}], "children": []}]}, {"title": "301aed3d27", "left": [{"key": "lazy", "val": 1.0}], "right": [], "before": [{"key": "a", "val": 1.0}, {"key": "liked", "val": 0.5}, {"key": "woman", "val": 0.3333333333333333}], "after": [{"key": "woman", "val": 1.0}, {"key": "with", "val": 0.5}, {"key": "the", "val": 0.3333333333333333}], "children": []}]}, {"title": "4670d7feeb", "left": [{"key": "woman", "val": 1.0}], "right": [{"key": "CONCEPT-2739233090999916_1", "val": 1.0}, {"key": "CONCEPT-2739250549584916_2242", "val": 1.0}, {"key": "CONCEPT-2739250549622583_2246", "val": 1.0}, {"key": "CONCEPT-2739250549659250_2251", "val": 1.0}, {"key": "CONCEPT-2739250549706708_2254", "val": 1.0}, {"key": "CONCEPT-2739250549726458_2256", "val": 1.0}, {"key": "CONCEPT-2739250549749166_2259", "val": 1.0}], "before": [{"key": "lazy", "val": 1.0}, {"key": "a", "val": 0.5}, {"key": "liked", "val": 0.3333333333333333}], "after": [], "children": [{"title": "14dac659fc", "left": [{"key": "woman", "val": 1.0}], "right": [], "before": [{"key": "lazy", "val": 1.0}, {"key": "a", "val": 0.5}, {"key": "liked", "val": 0.3333333333333333}], "after": [{"key": "with", "val": 1.0}, {"key": "the", "val": 0.5}, {"key": "cat", "val": 0.3333333333333333}], "children": []}, {"title": "e9bc79029d", "left": [{"key": "with", "val": 1.0}], "right": [{"key": "CONCEPT-2739233090999916_1", "val": 1.0}, {"key": "CONCEPT-2739236583571666_220", "val": 1.0}, {"key": "CONCEPT-2739236583647416_230", "val": 1.0}, {"key": "CONCEPT-2739238953018041_294", "val": 1.0}, {"key": "CONCEPT-2739238953067833_298", "val": 1.0}, {"key": "CONCEPT-2739238953097916_301", "val": 1.0}, {"key": "CONCEPT-2739238953146916_304", "val": 1.0}], "before": [{"key": "woman", "val": 1.0}, {"key": "lazy", "val": 0.5}, {"key": "a", "val": 0.3333333333333333}], "after": [], "children": [{"title": "d99b70865d", "left": [{"key": "with", "val": 1.0}], "right": [], "before": [{"key": "woman", "val": 1.0}, {"key": "lazy", "val": 0.5}, {"key": "a", "val": 0.3333333333333333}], "after": [{"key": "the", "val": 1.0}, {"key": "cat", "val": 0.5}], "children": []}, {"title": "7d7ee7e1cd", "left": [{"key": "the", "val": 1.0}], "right": [{"key": "cat", "val": 1.0}], "before": [{"key": "with", "val": 1.0}, {"key": "woman", "val": 0.5}, {"key": "lazy", "val": 0.3333333333333333}], "after": [], "children": [{"title": "ffe3b15b04", "left": [{"key": "the", "val": 1.0}], "right": [], "before": [{"key": "with", "val": 1.0}, {"key": "woman", "val": 0.5}, {"key": "lazy", "val": 0.3333333333333333}], "after": [{"key": "cat", "val": 1.0}], "children": []}, {"title": "24264ea476", "left": [{"key": "cat", "val": 1.0}], "right": [], "before": [{"key": "the", "val": 1.0}, {"key": "with", "val": 0.5}, {"key": "woman", "val": 0.3333333333333333}], "after": [], "children": []}]}]}]}]}]};
    const nodeW  = 280;
    const nodeH  = 130;
    const hGap   = 80;
    const vGap   = 150;

    const root = d3.hierarchy(data);
    const layout = d3.tree().nodeSize([nodeW + hGap, nodeH + vGap]);
    layout(root);

    // compute bounds
    let x0 = Infinity, x1 = -Infinity, y0 = Infinity, y1 = -Infinity;
    root.each(d => {
        if (d.x < x0) x0 = d.x;
        if (d.x > x1) x1 = d.x;
        if (d.y < y0) y0 = d.y;
        if (d.y > y1) y1 = d.y;
    });
    const width  = x1 - x0 + nodeW + 320;
    const height = y1 - y0 + nodeH + 320; // THIS IS THE HEIGHT MODIFIER

    const svg = d3.select("#tree").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("viewBox", [x0 - nodeW/2, y0 - nodeH/2, width, height].join(" "));

    const g = svg.append("g");

    // links
    g.selectAll("path.link")
    .data(root.links())
    .join("path")
    .attr("class", "link")
    .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

    // nodes
    const node = g.selectAll("g.node")
    .data(root.descendants())
    .join("g")
    .attr("transform", d => `translate(${d.x},${d.y})`);

    // node rect
    node.append("rect")
    .attr("class", "node-box")
    .attr("x", -nodeW/2)
    .attr("y", 0)
    .attr("width", nodeW)
    .attr("height", nodeH);

    // node HTML via foreignObject
    node.append("foreignObject")
    .attr("class", "node-fo")
    .attr("x", -nodeW/2 + 6)
    .attr("y", 6)
    .attr("width", nodeW - 12)
    .attr("height", 1000)
    .html(d => nodeHTML(d.data));

    // shrink foreignObjects to actual content height
    node.selectAll("foreignObject").each(function() {
    const fo = d3.select(this);
    const div = fo.select("div").node();
    const h = div.getBoundingClientRect().height + 6;
    fo.attr("height", h);
    d3.select(this.parentNode).select("rect").attr("height", h + 12);
    });

    function nodeHTML(d) {
        const ctxTable = (ctx, title) => {
            if (!ctx || ctx.length === 0) return `<div class="subtable"><i>${title}: empty</i></div>`;
            const rows = ctx.map(kv => `<tr><td>${kv.key}</td><td>${kv.val.toFixed(2)}</td></tr>`).join("");
            return `<div class="subtable"><b>${title}</b><table><tbody>${rows}</tbody></table></div>`;
        };

        // content: left and right are now lists of {key, val}
        let contentHTML = "";
        const leftHas = Array.isArray(d.left) && d.left.length > 0;
        const rightHas = Array.isArray(d.right) && d.right.length > 0;

        if (rightHas) {
            // composite-style node: show both left and right content tables
            contentHTML = `<div class="section">${ctxTable(d.left, "Content-Left")}${ctxTable(d.right, "Content-Right")}</div>`;
        } else if (leftHas) {
            // primitive or single-sided composite: show a single content table
            // label it "Content" for primitives
            const label = (d.right && d.right.length > 0) ? "Content-Left" : "Content";
            contentHTML = `<div class="section">${ctxTable(d.left, label)}</div>`;
        } else {
            contentHTML = `<div class="section"><i>Content: empty</i></div>`;
        }

        return `
        <div class="node-fo">
            <table><tr><th colspan="2">${d.title}</th></tr></table>
            ${contentHTML}
            ${ctxTable(d.before, "Context-Before")}
            ${ctxTable(d.after,  "Context-After")}
        </div>`;
    }

    </script>
    </body>
    </html>
    